name: Append Release Notes

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  append-notes:
    runs-on: ubuntu-latest
    steps:
      - name: Generate extra release notes
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"

          cat <<EOF > extra_notes.md
          ## Registry Codes Database Release ${TAG_NAME}

          Generated on $(date)

          ## Contents
          - **registry_codes.sqlite**: SQLite database file with all registry codes
          - **registry_codes.dump**: PostgreSQL SQL dump file with all registry codes

          ## Download Examples

          ### SQLite Database
          \`\`\`bash
          curl -L -o registry_codes.sqlite https://github.com/renalreg/registry-codes/releases/download/${TAG_NAME}/registry_codes.sqlite
          sqlite3 registry_codes.sqlite 'SELECT * FROM modality_codes LIMIT 5;'
          \`\`\`

          ### PostgreSQL Dump
          \`\`\`bash
          curl -L -o registry_codes.dump https://github.com/renalreg/registry-codes/releases/download/${TAG_NAME}/registry_codes.dump
          psql -U postgres -d your_database_name -f registry_codes.dump
          \`\`\`
          EOF

      - name: Fetch existing release notes
        run: |
          curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/releases/${{ github.event.release.id }} \
            | jq -r '.body' > current_body.md

      - name: Append and update release
        run: |
          cat current_body.md extra_notes.md > combined.md

          jq -n --rawfile body combined.md \
            '{ body: $body }' > payload.json

          curl -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d @payload.json \
            https://api.github.com/repos/${{ github.repository }}/releases/${{ github.event.release.id }}
