name: Append Registry Codes Release Notes

on:
  tags:
    - 'v*'

  workflow_dispatch:
    release:
    types: [published]

permissions:
  contents: write

jobs:
  append-notes:
    runs-on: ubuntu-latest

    steps:
      - name: Create release notes
        run: |
          echo "# Registry Codes Database Release ${{ env.TAG_NAME }}" > release_notes.md
          echo "" >> release_notes.md
          echo "Generated on $(date)" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Contents" >> release_notes.md
          echo "" >> release_notes.md
          echo "- **registry_codes.sqlite**: SQLite database file with all registry codes" >> release_notes.md
          echo "- **registry_codes.dump**: PostgreSQL SQL dump file with all registry codes" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Download Examples" >> release_notes.md
          echo "" >> release_notes.md
          echo "### SQLite Database" >> release_notes.md
          echo "" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo "# Download with curl" >> release_notes.md
          echo "curl -L -o registry_codes.sqlite https://github.com/renalreg/registry-codes/releases/download/${{ env.TAG_NAME }}/registry_codes.sqlite" >> release_notes.md
          echo "" >> release_notes.md
          echo "# Use the database" >> release_notes.md
          echo "sqlite3 registry_codes.sqlite 'SELECT * FROM modality_codes LIMIT 5;'" >> release_notes.md
          echo '```' >> release_notes.md
          echo "" >> release_notes.md
          echo "### PostgreSQL Dump" >> release_notes.md
          echo "" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo "# Download with curl" >> release_notes.md
          echo "curl -L -o registry_codes.dump https://github.com/renalreg/registry-codes/releases/download/${{ env.TAG_NAME }}/registry_codes.dump" >> release_notes.md
          echo "" >> release_notes.md
          echo "# Restore to a PostgreSQL database" >> release_notes.md
          echo "psql -U postgres -d your_database_name -f registry_codes.dump" >> release_notes.md
          echo '```' >> release_notes.md
          echo "" >> release_notes.md

      - name: Create or Append to Release Notes
        run: |
          if [ -f release.md ]; then
            echo "Appending to existing release.md..."
            cat release_notes.md >> release.md
          else
            echo "Creating new release.md..."
            mv release_notes.md release.md
          fi
 