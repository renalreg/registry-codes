name: Append Registry Codes Release Notes

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  append-notes:
    runs-on: ubuntu-latest

    steps:
      - name: Append database notes to release description
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const releaseFromEvent = context.payload.release;
            const tag = releaseFromEvent.tag_name;

            // Fetch the latest version of this release to ensure we don't overwrite
            const { data: release } = await github.repos.getRelease({
              owner,
              repo,
              release_id: releaseFromEvent.id,
            });

            const existing = release.body || "";

            const snippet = `\n\n---\n\n` +
`## Registry Codes Database Release ${tag}\n\n` +
`### Contents\n\n` +
`- **registry_codes.sqlite**: SQLite database file with all registry codes\n` +
`- **registry_codes_ods.sqlite**: SQLite ODS database file with all registry codes\n` +
`- **registry_codes.dump**: PostgreSQL SQL dump file with all registry codes\n\n` +
`### Download examples\n\n` +
"#### SQLite database\n\n" +
"```bash\n" +
"# Download with curl\n" +
`curl -L -o registry_codes.sqlite https://github.com/${owner}/${repo}/releases/download/${tag}/registry_codes.sqlite\n` +
"\n" +
"# Use the database\n" +
"sqlite3 registry_codes.sqlite 'SELECT * FROM modality_codes LIMIT 5;'\n" +
"```\n\n" +
"#### PostgreSQL dump\n\n" +
"```bash\n" +
"# Download with curl\n" +
`curl -L -o registry_codes.dump https://github.com/${owner}/${repo}/releases/download/${tag}/registry_codes.dump\n` +
"\n" +
"# Restore to a PostgreSQL database\n" +
"psql -U postgres -d your_database_name -f registry_codes.dump\n" +
"```\n";

            const body = existing + snippet;

            await github.repos.updateRelease({
              owner,
              repo,
              release_id: release.id,
              body,
            });